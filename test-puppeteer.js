/**
 * Puppeteer Installation Test
 *
 * Simple script to verify Puppeteer can launch and generate PDFs.
 * Run with: node test-puppeteer.js
 */

const puppeteer = require('puppeteer')
const fs = require('fs')
const path = require('path')

async function testPuppeteer() {
  console.log('üöÄ Testing Puppeteer installation...\n')

  let browser
  try {
    // Test 1: Launch browser
    console.log('1Ô∏è‚É£ Launching headless browser...')
    browser = await puppeteer.launch({
      headless: true,
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-gpu',
      ],
    })
    console.log('‚úÖ Browser launched successfully\n')

    // Test 2: Create page
    console.log('2Ô∏è‚É£ Creating new page...')
    const page = await browser.newPage()
    console.log('‚úÖ Page created successfully\n')

    // Test 3: Set HTML content
    console.log('3Ô∏è‚É£ Setting HTML content...')
    const html = `
      <!DOCTYPE html>
      <html>
        <head>
          <style>
            body {
              font-family: Arial, sans-serif;
              padding: 40px;
              max-width: 800px;
              margin: 0 auto;
            }
            h1 {
              color: #2563eb;
              border-bottom: 3px solid #2563eb;
              padding-bottom: 10px;
            }
            .section {
              margin: 20px 0;
            }
            .checkmark {
              color: #10b981;
              font-size: 24px;
            }
          </style>
        </head>
        <body>
          <h1>Puppeteer Test - KairosCV</h1>

          <div class="section">
            <h2><span class="checkmark">‚úì</span> Installation Status</h2>
            <p>Puppeteer is installed and working correctly!</p>
          </div>

          <div class="section">
            <h2>System Information</h2>
            <ul>
              <li><strong>Date:</strong> ${new Date().toLocaleDateString()}</li>
              <li><strong>Time:</strong> ${new Date().toLocaleTimeString()}</li>
              <li><strong>Puppeteer Version:</strong> ${puppeteer.version || '24.x'}</li>
              <li><strong>Node Version:</strong> ${process.version}</li>
            </ul>
          </div>

          <div class="section">
            <h2>Next Steps</h2>
            <ol>
              <li>Create HTML resume templates</li>
              <li>Implement Handlebars template engine</li>
              <li>Build PDF generator service</li>
              <li>Integrate with resume processor</li>
            </ol>
          </div>

          <div class="section">
            <p style="color: #6b7280; font-size: 14px; margin-top: 40px;">
              ü§ñ Generated by KairosCV Puppeteer Test
            </p>
          </div>
        </body>
      </html>
    `

    await page.setContent(html, { waitUntil: 'networkidle0' })
    console.log('‚úÖ HTML content set successfully\n')

    // Test 4: Generate PDF
    console.log('4Ô∏è‚É£ Generating PDF...')
    const outputPath = path.join(__dirname, 'test-output.pdf')
    await page.pdf({
      path: outputPath,
      format: 'Letter',
      printBackground: true,
      margin: {
        top: '0.5in',
        right: '0.5in',
        bottom: '0.5in',
        left: '0.5in',
      },
    })
    console.log(`‚úÖ PDF generated successfully: ${outputPath}\n`)

    // Test 5: Verify file exists
    console.log('5Ô∏è‚É£ Verifying PDF file...')
    const stats = fs.statSync(outputPath)
    console.log(`‚úÖ PDF file exists (${(stats.size / 1024).toFixed(2)} KB)\n`)

    console.log('üéâ All tests passed!')
    console.log('üìÑ Test PDF location:', outputPath)
    console.log('\n‚ú® Puppeteer is ready for HTML-to-PDF generation!')

  } catch (error) {
    console.error('\n‚ùå Test failed:', error.message)
    console.error('\nTroubleshooting:')
    console.error('1. Make sure pnpm install completed successfully')
    console.error('2. Check if Chromium was downloaded')
    console.error('3. Try running: pnpm approve-builds (select puppeteer)')
    console.error('4. On Windows, you may need Visual C++ Redistributable')
    process.exit(1)
  } finally {
    if (browser) {
      await browser.close()
      console.log('\nüîí Browser closed')
    }
  }
}

// Run test
testPuppeteer()
